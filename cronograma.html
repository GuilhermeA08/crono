<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cronograma Sem Firebase</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background: #f8f9fa;
        padding-top: 20px;
      }
      .container {
        max-width: 1200px;
      }
      .card {
        border-radius: 15px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        background: #fff;
        transition: 0.2s;
      }
      .card:hover {
        transform: translateY(-3px);
      }
      .card-header {
        background: #007bff;
        color: #fff;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .drop-zone {
        min-height: 100px;
        border: 2px dashed #ced4da;
        border-radius: 8px;
        padding: 10px;
        margin-top: 10px;
        background: #f1f3f5;
        transition: all 0.3s;
      }
      .drop-zone.drag-over {
        background: #d1e7dd;
        border-color: #28a745;
        box-shadow: 0 0 10px rgba(40, 167, 69, 0.3);
      }
      .person-item {
        border: 1px solid #dee2e6;
        border-radius: 10px;
        margin-bottom: 8px;
        cursor: grab;
        overflow: hidden;
        transition: all 0.2s;
      }
      .person-item:hover {
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      }
      .person-item:active {
        cursor: grabbing;
      }
      .person-item .person-header {
        padding: 6px 10px;
        color: #fff;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .role-transmissao {
        background: #28a745;
      }
      .role-fotos {
        background: #fd7e14;
      }
      /* Cores dinâmicas para outras funções */
      .role-transmisso {
        background: #28a745;
      }
      .role-foto {
        background: #fd7e14;
      }
      .role-som {
        background: #17a2b8;
      }
      .role-iluminacao {
        background: #ffc107;
        color: #212529;
      }
      .role-camera {
        background: #6f42c1;
      }
      .role-edicao {
        background: #e83e8c;
      }
      .role-direcao {
        background: #20c997;
      }
      .role-producao {
        background: #fd7e14;
      }
      /* Cor padrão para funções não mapeadas */
      .role- {
        background: #6c757d;
      }
      .person-item .person-body {
        padding: 6px 10px;
        font-size: 0.9em;
        background: #f8f9fa;
        color: #495057;
      }
      .remove-person-from-day {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: #fff;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .remove-person-from-day:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }
      .remove-day-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: #fff;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .remove-day-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }
      .people-list-container {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 8px;
      }
      .people-list-container::-webkit-scrollbar {
        width: 8px;
      }
      .people-list-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }
      .people-list-container::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
      }
      .people-list-container::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }
      
      /* Rolagem para os cards dos dias */
      .drop-zone {
        max-height: 300px;
        overflow-y: auto;
      }
      
      .drop-zone::-webkit-scrollbar {
        width: 6px;
      }
      
      .drop-zone::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
      }
      
      .drop-zone::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
      }
      
      .drop-zone::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }
      
      /* Cores para diferentes períodos */
      .period-manha .card-header {
        background: #28a745; /* Verde para manhã */
      }
      .period-tarde .card-header {
        background: #fd7e14; /* Laranja para tarde */
      }
      .period-noite .card-header {
        background: #6f42c1; /* Roxo para noite */
      }
      .period-diatodo .card-header {
        background: #007bff; /* Azul para dia todo */
      }
      
      /* Estilos para impressão */
      @media print {
        @page {
          size: landscape;
          margin: 5mm;
        }
        
        /* Ocultar cabeçalho e rodapé do navegador */
        @page {
          margin-top: 0;
          margin-bottom: 0;
        }
        
        body {
          background: white !important;
          padding: 0 !important;
          margin: 0 !important;
        }
        
        .container {
          max-width: none !important;
          margin: 0 !important;
          padding: 5px !important;
        }
        
        /* Ocultar informações do navegador */
        html {
          margin: 0 !important;
          padding: 0 !important;
        }
        
        /* Remover espaços desnecessários */
        * {
          box-sizing: border-box !important;
        }
        
        h1 {
          color: #000 !important;
          font-size: 24px !important;
          margin-bottom: 20px !important;
          text-align: center !important;
        }
        
        .btn, .text-center.mb-4, .row.mb-4 {
          display: none !important;
        }
        
        .card {
          box-shadow: none !important;
          border: 2px solid #333 !important;
          margin-bottom: 15px !important;
          break-inside: avoid !important;
          page-break-inside: avoid !important;
        }
        
        .card-header {
          color: white !important;
          padding: 10px !important;
          font-weight: bold !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }
        
        .person-item {
          margin-bottom: 5px !important;
          border: 1px solid #333 !important;
          break-inside: avoid !important;
        }
        
        .person-header {
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
          padding: 5px 8px !important;
          color: white !important;
          font-weight: bold !important;
        }
        
        .person-body {
          padding: 5px 8px !important;
          background: #f8f9fa !important;
          font-size: 12px !important;
        }
        
        .remove-person-from-day, .remove-day-btn, .edit-day-btn, .add-person-to-day-btn {
          display: none !important;
        }
        
        .drop-zone {
          border: none !important;
          background: white !important;
          padding: 8px !important;
          max-height: none !important;
          overflow: visible !important;
        }
        
        .col-md-3 {
          width: 23% !important;
          display: inline-block !important;
          vertical-align: top !important;
          margin-bottom: 30px !important;
          margin-right: 2% !important;
        }
        
        #scheduleDaysContainer {
          column-count: 4 !important;
          column-gap: 15px !important;
        }
        
        /* Quebra de página a cada 4 cards (1 linha de 4) */
        .col-md-3:nth-child(4n+1) {
          page-break-before: always !important;
        }
        
        /* Cores específicas para impressão */
        .period-manha .card-header {
          background: #28a745 !important;
        }
        .period-tarde .card-header {
          background: #fd7e14 !important;
        }
        .period-noite .card-header {
          background: #6f42c1 !important;
        }
        .period-diatodo .card-header {
          background: #007bff !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="text-center text-primary mb-4">Gerenciador de Cronograma</h1>

      <!-- Botões de ação -->
      <div class="text-center mb-4">
        <button id="exportPdfBtn" class="btn btn-outline-success me-2">
          <i class="fas fa-file-pdf"></i> Exportar para PDF
        </button>
        <button id="printBtn" class="btn btn-outline-info me-2">
          <i class="fas fa-print"></i> Imprimir
        </button>
        <button id="clearAllBtn" class="btn btn-outline-danger">
          <i class="fas fa-trash-alt"></i> Limpar Todos os Dados
        </button>
      </div>

      <div class="row mb-4">
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">Cadastro de Pessoas</div>
            <div class="card-body">
              <div class="input-group mb-3">
                <input
                  id="personNameInput"
                  class="form-control"
                  placeholder="Nome da pessoa"
                />
                <button id="addPersonBtn" class="btn btn-primary">
                  Adicionar
                </button>
              </div>
              <div class="people-list-container">
                <ul id="peopleList" class="list-group list-group-flush"></ul>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">Cadastro de Funções</div>
            <div class="card-body">
              <div class="input-group mb-3">
                <input
                  id="roleNameInput"
                  class="form-control"
                  placeholder="Nome da função"
                />
                <button id="addRoleBtn" class="btn btn-primary">
                  Adicionar
                </button>
              </div>
              <div class="people-list-container">
                <ul id="rolesList" class="list-group list-group-flush"></ul>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">Adicionar Dia</div>
            <div class="card-body">
              <div class="mb-3">
                <input id="calendarInput" type="date" class="form-control mb-2" />
                <select id="periodSelect" class="form-select mb-2">
                  <option value="Manhã">Manhã</option>
                  <option value="Tarde">Tarde</option>
                  <option value="Noite">Noite</option>
                  <option value="Dia todo">Dia todo</option>
                </select>
                <button id="addDayBtn" class="btn btn-success w-100">
                  Adicionar
                </button>
              </div>
              <small class="text-muted">Selecione a data e o período</small>
            </div>
          </div>
        </div>
      </div>
      <div id="scheduleDaysContainer" class="row"></div>
    </div>

    <!-- Modal de edição de allocation -->
    <div class="modal fade" id="editAllocationModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">Editar Função</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p><strong>Pessoa:</strong> <span id="editAllocName"></span></p>
            <p><strong>Data:</strong> <span id="editAllocDate"></span></p>
            <select id="editAllocRole" class="form-select mb-2">
              <!-- Opções serão preenchidas dinamicamente -->
            </select>
          </div>
          <div class="modal-footer">
            <button id="saveAllocBtn" class="btn btn-primary">Salvar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de edição de dia -->
    <div class="modal fade" id="editDayModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title">Editar Dia</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="editDayDate" class="form-label">Data:</label>
              <input id="editDayDate" type="date" class="form-control">
            </div>
            <div class="mb-3">
              <label for="editDayPeriod" class="form-label">Período:</label>
              <select id="editDayPeriod" class="form-select">
                <option value="Manhã">Manhã</option>
                <option value="Tarde">Tarde</option>
                <option value="Noite">Noite</option>
                <option value="Dia todo">Dia todo</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button id="saveDayBtn" class="btn btn-success">Salvar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de edição de pessoa -->
    <div class="modal fade" id="editPersonModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-info text-white">
            <h5 class="modal-title">Editar Pessoa</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="editPersonName" class="form-label">Nome:</label>
              <input id="editPersonName" type="text" class="form-control">
            </div>
          </div>
          <div class="modal-footer">
            <button id="savePersonBtn" class="btn btn-info">Salvar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para adicionar pessoa ao dia -->
    <div class="modal fade" id="addPersonToDayModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">Adicionar Pessoa ao Dia</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p><strong>Dia:</strong> <span id="addPersonDayInfo"></span></p>
            <div class="mb-3">
              <label for="selectPersonToAdd" class="form-label">Digite ou selecione a pessoa:</label>
              <input 
                type="text" 
                id="selectPersonToAdd" 
                class="form-control" 
                list="peopleOptions"
                placeholder="Digite o nome ou selecione..."
                autocomplete="off"
              >
              <datalist id="peopleOptions">
                <!-- Opções serão preenchidas dinamicamente -->
              </datalist>
            </div>
            <div class="mb-3">
              <label for="selectRoleForPerson" class="form-label">Função:</label>
              <select id="selectRoleForPerson" class="form-select">
                <!-- Opções serão preenchidas dinamicamente -->
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button id="addPersonToDayBtn" class="btn btn-primary">Adicionar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Alertas -->
    <div class="modal fade" id="alertModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-warning">
            <h5 class="modal-title">Aviso</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div id="alertBody" class="modal-body"></div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              Fechar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de confirmação para limpar dados -->
    <div class="modal fade" id="confirmClearModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">Confirmar Limpeza</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p><strong>Atenção!</strong> Esta ação irá remover:</p>
            <ul>
              <li>Todas as pessoas cadastradas</li>
              <li>Todos os dias do cronograma</li>
              <li>Todas as alocações de funções</li>
            </ul>
            <p>
              Esta ação não pode ser desfeita. Tem certeza que deseja continuar?
            </p>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              Cancelar
            </button>
            <button id="confirmClearBtn" class="btn btn-danger">
              Sim, Limpar Tudo
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS & Popper -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    <!-- jsPDF para exportar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
      // dados + localStorage
      let people = JSON.parse(localStorage.getItem("cron_people") || "[]");
      let scheduleDays = JSON.parse(localStorage.getItem("cron_days") || "[]");
      let roles = JSON.parse(
        localStorage.getItem("cron_roles") || '["Transmissão", "Fotos"]'
      );
      let roleColors = JSON.parse(
        localStorage.getItem("cron_role_colors") ||
          '{"Transmissão": "#28a745", "Fotos": "#fd7e14"}'
      );
      let current = {};

      // Paleta de cores predefinidas para funções
      const colorPalette = [
        "#28a745",
        "#fd7e14",
        "#007bff",
        "#6f42c1",
        "#e83e8c",
        "#17a2b8",
        "#ffc107",
        "#dc3545",
        "#20c997",
        "#6c757d",
        "#f8f9fa",
        "#343a40",
        "#ff6b6b",
        "#4ecdc4",
        "#45b7d1",
        "#f39c12",
        "#9b59b6",
        "#e74c3c",
        "#2ecc71",
        "#f1c40f",
        "#3498db",
        "#e67e22",
        "#95a5a6",
        "#34495e",
      ];

      function getColorForRole(role) {
        if (roleColors[role]) {
          return roleColors[role];
        }

        // Atribuir uma cor da paleta baseada no índice da função
        const roleIndex = roles.indexOf(role);
        const color = colorPalette[roleIndex % colorPalette.length];
        roleColors[role] = color;
        save();
        return color;
      }

      function createDynamicRoleStyles() {
        // Remove estilos antigos
        const existingStyle = document.getElementById("dynamic-role-styles");
        if (existingStyle) {
          existingStyle.remove();
        }

        // Cria novos estilos
        const style = document.createElement("style");
        style.id = "dynamic-role-styles";
        let css = "";

        roles.forEach((role) => {
          const color = getColorForRole(role);
          const className = role.toLowerCase().replace(/[^a-z]/g, "");
          const textColor = isLightColor(color) ? "#212529" : "#fff";
          css += `.role-${className} { background: ${color}; color: ${textColor}; }\n`;
        });

        style.textContent = css;
        document.head.appendChild(style);
      }

      function isLightColor(color) {
        // Converte hex para RGB e calcula luminância
        const hex = color.replace("#", "");
        const r = parseInt(hex.substr(0, 2), 16);
        const g = parseInt(hex.substr(2, 2), 16);
        const b = parseInt(hex.substr(4, 2), 16);
        const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
        return luminance > 0.5;
      }

      function save() {
        localStorage.setItem("cron_people", JSON.stringify(people));
        localStorage.setItem("cron_days", JSON.stringify(scheduleDays));
        localStorage.setItem("cron_roles", JSON.stringify(roles));
        localStorage.setItem("cron_role_colors", JSON.stringify(roleColors));
      }

      function showAlert(msg) {
        document.getElementById("alertBody").textContent = msg;
        new bootstrap.Modal(document.getElementById("alertModal")).show();
      }

      // Renderizações
      function renderPeople() {
        const ul = document.getElementById("peopleList");
        ul.innerHTML = "";
        
        // Ordenar pessoas alfabeticamente
        const sortedPeople = [...people].sort((a, b) => a.name.localeCompare(b.name));
        
        sortedPeople.forEach((p) => {
          const li = document.createElement("li");
          li.className = "list-group-item d-flex justify-content-between";
          li.draggable = true;
          li.dataset.id = p.id;
          li.innerHTML = `<span>${p.name}</span>
                        <div class="d-flex gap-1">
                          <button class="btn btn-sm btn-outline-info edit-person-btn" data-id="${p.id}">
                            <i class="fas fa-edit"></i>
                          </button>
                          <button class="btn btn-sm btn-danger delete-person-btn">&times;</button>
                        </div>`;
          // delete
          li.querySelector(".delete-person-btn").onclick = () => {
            people = people.filter((x) => x.id !== p.id);
            scheduleDays.forEach(
              (d) =>
                (d.allocatedPeople = d.allocatedPeople.filter(
                  (x) => x.id !== p.id
                ))
            );
            save();
            renderAll();
          };
          // edit
          li.querySelector(".edit-person-btn").onclick = () => {
            current.personId = p.id;
            document.getElementById("editPersonName").value = p.name;
            new bootstrap.Modal(document.getElementById("editPersonModal")).show();
          };
          // drag
          li.addEventListener("dragstart", (e) => {
            e.dataTransfer.setData("text/plain", p.id);
          });
          ul.appendChild(li);
        });
      }

      function renderRoles() {
        const ul = document.getElementById("rolesList");
        ul.innerHTML = "";
        
        // Ordenar funções alfabeticamente
        const sortedRoles = [...roles].sort((a, b) => a.localeCompare(b));
        
        sortedRoles.forEach((role) => {
          const index = roles.indexOf(role); // Manter referência ao índice original
          const li = document.createElement("li");
          li.className =
            "list-group-item d-flex justify-content-between align-items-center";
          const color = getColorForRole(role);
          const textColor = isLightColor(color) ? "#212529" : "#fff";

          li.innerHTML = `
          <div class="d-flex align-items-center">
            <div style="width: 20px; height: 20px; background: ${color}; border-radius: 50%; margin-right: 10px;"></div>
            <span>${role}</span>
          </div>
          <button class="btn btn-sm btn-danger" ${
            roles.length <= 1 ? "disabled" : ""
          }>&times;</button>`;

          // delete (não permitir deletar se só tem 1 função)
          li.querySelector("button").onclick = () => {
            if (roles.length > 1) {
              // Remover a cor da função também
              delete roleColors[role];
              roles.splice(index, 1);
              // Atualizar pessoas já alocadas que tinham essa função
              scheduleDays.forEach((d) => {
                d.allocatedPeople.forEach((p) => {
                  if (p.role === role) {
                    p.role = roles[0]; // Atribuir primeira função disponível
                  }
                });
              });
              save();
              renderAll();
            }
          };
          ul.appendChild(li);
        });
      }

      function renderDays() {
        const cont = document.getElementById("scheduleDaysContainer");
        cont.innerHTML = "";

        // Ordenar os dias por data e período
        const periodOrder = { 'Manhã': 1, 'Tarde': 2, 'Noite': 3, 'Dia todo': 4 };
        const sortedDays = scheduleDays.sort((a, b) => {
          const dateA = new Date(a.date);
          const dateB = new Date(b.date);
          
          if (dateA.getTime() !== dateB.getTime()) {
            return dateA - dateB;
          }
          
          // Se as datas são iguais, ordenar por período
          return (periodOrder[a.period] || 5) - (periodOrder[b.period] || 5);
        });

        sortedDays.forEach((d) => {
          const col = document.createElement("div");
          col.className = "col-md-3 mb-4";

          // Converter data ISO para exibição correta
          const [year, month, day] = d.date.split("-");
          const displayDate = `${day}/${month}/${year}`;

          // Obter o dia da semana
          const dateObj = new Date(year, month - 1, day); // month - 1 porque o mês é 0-indexed
          const daysOfWeek = [
            "Domingo",
            "Segunda",
            "Terça",
            "Quarta",
            "Quinta",
            "Sexta",
            "Sábado",
          ];
          const dayOfWeek = daysOfWeek[dateObj.getDay()];

          // Classe para cor do período
          const periodClass = `period-${(d.period || 'Dia todo').toLowerCase().replace(/\s+/g, '')}`;

          col.innerHTML = `
          <div class="card ${periodClass}">
            <div class="card-header d-flex justify-content-between">
              <div>
                <div style="font-weight: bold;">${dayOfWeek}</div>
                <div style="font-size: 0.9em;">${displayDate}</div>
                <div style="font-size: 0.8em; opacity: 0.9;">${d.period || 'Dia todo'}</div>
              </div>
              <div class="d-flex gap-1">
                <button class="edit-day-btn" style="background:rgba(255,255,255,0.2); border:none; color:#fff; border-radius:50%; width:20px; height:20px; display:flex; align-items:center; justify-content:center; font-size:12px; cursor:pointer; transition:all 0.2s;" title="Editar dia">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="remove-day-btn">&times;</button>
              </div>
            </div>
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <small class="text-muted">Arraste pessoas ou</small>
                <button class="btn btn-sm btn-outline-primary add-person-to-day-btn" data-day-id="${d.id}">
                  <i class="fas fa-plus"></i> Adicionar
                </button>
              </div>
              <div class="drop-zone" data-id="${d.id}">
                ${d.allocatedPeople
                  .map(
                    (p) => `
                  <div class="person-item" draggable="true" data-id="${
                    p.id
                  }" data-date="${d.date}">
                    <div class="person-header role-${p.role
                      .toLowerCase()
                      .replace(/[^a-z]/g, "")}">
                      <span>${p.name}</span>
                      <button class="remove-person-from-day">&times;</button>
                    </div>
                    <div class="person-body">
                      <strong>Função:</strong> ${p.role}
                    </div>
                  </div>`
                  )
                  .join("")}
              </div>
            </div>
          </div>`;
          // remove day
          col.querySelector(".remove-day-btn").onclick = () => {
            scheduleDays = scheduleDays.filter((x) => x.id !== d.id);
            save();
            renderAll();
          };
          
          // edit day
          col.querySelector(".edit-day-btn").onclick = () => {
            current.dayId = d.id;
            document.getElementById("editDayDate").value = d.date;
            document.getElementById("editDayPeriod").value = d.period || 'Dia todo';
            new bootstrap.Modal(document.getElementById("editDayModal")).show();
          };
          
          // add person to day
          col.querySelector(".add-person-to-day-btn").onclick = () => {
            current.dayId = d.id;
            
            // Mostrar informações do dia
            const [year, month, day] = d.date.split("-");
            const displayDate = `${day}/${month}/${year}`;
            const dateObj = new Date(year, month - 1, day);
            const dayOfWeek = ["Domingo", "Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"][dateObj.getDay()];
            const period = d.period || 'Dia todo';
            document.getElementById("addPersonDayInfo").textContent = `${dayOfWeek} - ${displayDate} (${period})`;
            
            // Preencher datalist com pessoas disponíveis (não já alocadas neste dia)
            const personInput = document.getElementById("selectPersonToAdd");
            const datalist = document.getElementById("peopleOptions");
            
            const availablePeople = people.filter(p => !d.allocatedPeople.find(ap => ap.id === p.id));
            
            // Ordenar alfabeticamente
            availablePeople.sort((a, b) => a.name.localeCompare(b.name));
            
            // Limpar e preencher datalist
            datalist.innerHTML = '';
            availablePeople.forEach(person => {
              const option = document.createElement("option");
              option.value = person.name;
              option.dataset.id = person.id;
              datalist.appendChild(option);
            });
            
            // Limpar input
            personInput.value = '';
            
            // Preencher select com funções
            const selectRole = document.getElementById("selectRoleForPerson");
            selectRole.innerHTML = '';
            
            // Ordenar funções alfabeticamente
            const sortedRoles = [...roles].sort((a, b) => a.localeCompare(b));
            sortedRoles.forEach(role => {
              const option = document.createElement("option");
              option.value = role;
              option.textContent = role;
              selectRole.appendChild(option);
            });
            
            if (availablePeople.length === 0) {
              showAlert("Todas as pessoas já estão alocadas neste dia ou não há pessoas cadastradas.");
              return;
            }
            
            new bootstrap.Modal(document.getElementById("addPersonToDayModal")).show();
          };
          // habilitar drop
          const dz = col.querySelector(".drop-zone");
          dz.addEventListener("dragover", (e) => {
            e.preventDefault();
            dz.classList.add("drag-over");
          });
          dz.addEventListener("dragleave", (e) => {
            dz.classList.remove("drag-over");
          });
          dz.addEventListener("drop", (e) => {
            e.preventDefault();
            dz.classList.remove("drag-over");
            const dragData = e.dataTransfer.getData("text/plain");

            // Verifica se é uma pessoa da lista ou uma pessoa já alocada
            if (dragData.startsWith("allocated:")) {
              // Pessoa sendo movida de outro dia
              const [, pid, sourceDate, sourcePeriod] = dragData.split(":");

              // Não permitir mover para o mesmo dia e período
              if (sourceDate === d.date && sourcePeriod === (d.period || 'Dia todo')) return;

              // Verificar se a pessoa já está neste dia
              if (d.allocatedPeople.find((x) => x.id === pid)) return;

              // Encontrar a pessoa no dia de origem
              const sourceDay = scheduleDays.find((x) => x.date === sourceDate && (x.period || 'Dia todo') === sourcePeriod);
              const personToMove = sourceDay.allocatedPeople.find(
                (x) => x.id === pid
              );

              // Remover do dia de origem
              sourceDay.allocatedPeople = sourceDay.allocatedPeople.filter(
                (x) => x.id !== pid
              );

              // Adicionar ao dia de destino
              d.allocatedPeople.push({
                id: personToMove.id,
                name: personToMove.name,
                role: personToMove.role,
              });

              save();
              renderAll();
            } else {
              // Pessoa nova sendo adicionada da lista
              const pid = dragData;
              if (!d.allocatedPeople.find((x) => x.id === pid)) {
                const person = people.find((x) => x.id === pid);
                d.allocatedPeople.push({
                  id: person.id,
                  name: person.name,
                  role: roles[0] || "Sem função",
                });
                save();
                renderAll();
              }
            }
          });
          // click em person-item abre modal
          col.querySelectorAll(".person-item").forEach((el) => {
            // habilitar drag para pessoas já alocadas
            el.addEventListener("dragstart", (e) => {
              const dayObj = scheduleDays.find(x => x.date === el.dataset.date);
              const period = dayObj.period || 'Dia todo';
              e.dataTransfer.setData(
                "text/plain",
                `allocated:${el.dataset.id}:${el.dataset.date}:${period}`
              );
            });

            el.onclick = () => {
              const pid = el.dataset.id,
                date = el.dataset.date;
              const alloc = scheduleDays
                .find((x) => x.date === date)
                .allocatedPeople.find((x) => x.id === pid);
              current = { date, pid };
              document.getElementById("editAllocName").textContent = alloc.name;

              // Converter data ISO para exibição correta
              const [year, month, day] = date.split("-");
              const displayDate = `${day}/${month}/${year}`;
              const dayObj = scheduleDays.find(x => x.date === date);
              const period = dayObj.period || 'Dia todo';
              document.getElementById("editAllocDate").textContent = `${displayDate} (${period})`;

              // Preencher select com funções dinâmicas
              const select = document.getElementById("editAllocRole");
              select.innerHTML = "";
              
              // Ordenar funções alfabeticamente
              const sortedRoles = [...roles].sort((a, b) => a.localeCompare(b));
              sortedRoles.forEach((role) => {
                const option = document.createElement("option");
                option.value = role;
                option.textContent = role;
                option.selected = role === alloc.role;
                select.appendChild(option);
              });

              new bootstrap.Modal(
                document.getElementById("editAllocationModal")
              ).show();
            };
          });
          // remove person-from-day
          col.querySelectorAll(".remove-person-from-day").forEach((btn) => {
            btn.onclick = (e) => {
              const pid = btn.closest(".person-item").dataset.id;
              d.allocatedPeople = d.allocatedPeople.filter((x) => x.id !== pid);
              save();
              renderAll();
              e.stopPropagation();
            };
          });
          cont.appendChild(col);
        });
      }

      // salvar edição de função
      document.getElementById("saveAllocBtn").onclick = () => {
        const newRole = document.getElementById("editAllocRole").value;
        const day = scheduleDays.find((x) => x.date === current.date);
        const alloc = day.allocatedPeople.find((x) => x.id === current.pid);
        alloc.role = newRole;
        save();
        renderAll();
        bootstrap.Modal.getInstance(
          document.getElementById("editAllocationModal")
        ).hide();
      };

      // salvar edição de dia
      document.getElementById("saveDayBtn").onclick = () => {
        const newDate = document.getElementById("editDayDate").value;
        const newPeriod = document.getElementById("editDayPeriod").value;
        
        if (!newDate) {
          return showAlert("Selecione uma data");
        }
        
        // Verificar se já existe um dia com a mesma data e período (exceto o atual)
        const existingDay = scheduleDays.find(x => 
          x.id !== current.dayId && 
          x.date === newDate && 
          x.period === newPeriod
        );
        
        if (existingDay) {
          return showAlert(`Já existe um cronograma para ${newPeriod.toLowerCase()} nesta data`);
        }
        
        const day = scheduleDays.find((x) => x.id === current.dayId);
        day.date = newDate;
        day.period = newPeriod;
        
        save();
        renderAll();
        bootstrap.Modal.getInstance(
          document.getElementById("editDayModal")
        ).hide();
      };

      // salvar edição de pessoa
      document.getElementById("savePersonBtn").onclick = () => {
        const newName = document.getElementById("editPersonName").value.trim();
        
        if (!newName) {
          return showAlert("Digite um nome");
        }
        
        // Verificar se já existe uma pessoa com o mesmo nome (exceto a atual)
        const existingPerson = people.find(p => 
          p.id !== current.personId && 
          p.name.toLowerCase() === newName.toLowerCase()
        );
        
        if (existingPerson) {
          return showAlert("Já existe uma pessoa com esse nome");
        }
        
        const person = people.find((p) => p.id === current.personId);
        person.name = newName;
        
        // Atualizar o nome também nos dias alocados
        scheduleDays.forEach(day => {
          day.allocatedPeople.forEach(allocatedPerson => {
            if (allocatedPerson.id === current.personId) {
              allocatedPerson.name = newName;
            }
          });
        });
        
        save();
        renderAll();
        bootstrap.Modal.getInstance(
          document.getElementById("editPersonModal")
        ).hide();
      };

      // adicionar pessoa ao dia
      document.getElementById("addPersonToDayBtn").onclick = () => {
        const personName = document.getElementById("selectPersonToAdd").value.trim();
        const roleSelected = document.getElementById("selectRoleForPerson").value;
        
        if (!personName) {
          return showAlert("Digite ou selecione uma pessoa");
        }
        
        if (!roleSelected) {
          return showAlert("Selecione uma função");
        }
        
        // Encontrar a pessoa pelo nome
        const person = people.find(p => p.name.toLowerCase() === personName.toLowerCase());
        
        if (!person) {
          return showAlert("Pessoa não encontrada. Verifique o nome digitado.");
        }
        
        const day = scheduleDays.find((d) => d.id === current.dayId);
        
        // Verificar se a pessoa já está alocada neste dia
        if (day.allocatedPeople.find(ap => ap.id === person.id)) {
          return showAlert("Esta pessoa já está alocada neste dia");
        }
        
        day.allocatedPeople.push({
          id: person.id,
          name: person.name,
          role: roleSelected
        });
        
        save();
        renderAll();
        bootstrap.Modal.getInstance(
          document.getElementById("addPersonToDayModal")
        ).hide();
      };

      // botões add
      document.getElementById("addPersonBtn").onclick = () => {
        const inp = document.getElementById("personNameInput");
        if (!inp.value.trim()) return showAlert("Digite um nome");
        people.push({ id: crypto.randomUUID(), name: inp.value.trim() });
        inp.value = "";
        save();
        renderAll();
      };

      document.getElementById("addRoleBtn").onclick = () => {
        const inp = document.getElementById("roleNameInput");
        if (!inp.value.trim()) return showAlert("Digite o nome da função");
        if (roles.includes(inp.value.trim()))
          return showAlert("Função já existe");

        const newRole = inp.value.trim();
        roles.push(newRole);
        // Atribuir cor automaticamente
        getColorForRole(newRole);

        inp.value = "";
        save();
        renderAll();
      };

      document.getElementById("addDayBtn").onclick = () => {
        const dateInput = document.getElementById("calendarInput");
        const periodSelect = document.getElementById("periodSelect");

        if (!dateInput.value) {
          return showAlert("Selecione uma data no calendário");
        }

        const isoDate = dateInput.value;
        const selectedPeriod = periodSelect.value;
        
        // Verificar se já existe um dia com a mesma data e período
        const existingDay = scheduleDays.find(x => x.date === isoDate && x.period === selectedPeriod);
        if (existingDay) {
          return showAlert(`Já existe um cronograma para ${selectedPeriod.toLowerCase()} nesta data`);
        }

        scheduleDays.push({
          id: crypto.randomUUID(),
          date: isoDate,
          period: selectedPeriod,
          allocatedPeople: [],
        });

        dateInput.value = "";
        periodSelect.value = "Manhã"; // Resetar para o primeiro valor
        save();
        renderAll();
      };

      function renderAll() {
        createDynamicRoleStyles();
        renderPeople();
        renderRoles();
        renderDays();
      }

      // Funcionalidade do botão de exportar para PDF
      document.getElementById("exportPdfBtn").onclick = () => {
        exportToPDF();
      };

      // Funcionalidade do botão de imprimir
      document.getElementById("printBtn").onclick = () => {
        // Verificar se há dados para imprimir
        if (scheduleDays.length === 0) {
          showAlert("Não há dados para imprimir. Adicione dias ao cronograma primeiro.");
          return;
        }
        
        // Imprimir diretamente a página atual
        window.print();
      };

      function exportToPDF() {
        const { jsPDF } = window.jspdf;
        
        // Verificar se há dados para exportar
        if (scheduleDays.length === 0) {
          showAlert("Não há dados para exportar. Adicione dias ao cronograma primeiro.");
          return;
        }
        
        // Mostrar indicador de carregamento
        const originalText = document.getElementById("exportPdfBtn").innerHTML;
        document.getElementById("exportPdfBtn").innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando PDF...';
        document.getElementById("exportPdfBtn").disabled = true;
        
        try {
          const doc = new jsPDF('portrait', 'mm', 'a4');
          const pageWidth = doc.internal.pageSize.getWidth();
          const pageHeight = doc.internal.pageSize.getHeight();
          const margin = 15;
          const lineHeight = 6;
          const columnWidth = (pageWidth - margin * 3) / 2; // Duas colunas
          const columnGap = 10;
          
          let currentY = margin;
          let currentColumn = 0; // 0 = coluna esquerda, 1 = coluna direita
          
          // Função para obter posição X baseada na coluna atual
          function getColumnX() {
            return currentColumn === 0 ? margin : margin + columnWidth + columnGap;
          }
          
          // Função para quebrar coluna/página
          function checkPageBreak(neededSpace) {
            if (currentY + neededSpace > pageHeight - 20) {
              if (currentColumn === 0) {
                // Mover para coluna direita
                currentColumn = 1;
                currentY = margin + 40; // Pular o cabeçalho
              } else {
                // Nova página
                doc.addPage();
                currentColumn = 0;
                currentY = margin;
                addHeader();
              }
            }
          }
          
          // Função para adicionar cabeçalho
          function addHeader() {
            // Título principal
            doc.setFontSize(20);
            doc.setTextColor(0, 123, 255);
            doc.text('CRONOGRAMA DE ATIVIDADES', pageWidth / 2, currentY, { align: 'center' });
            currentY += 12;
            
            // Data de geração
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Gerado em ${new Date().toLocaleDateString('pt-BR')}`, pageWidth / 2, currentY, { align: 'center' });
            currentY += 15;
            
            // Linha separadora
            doc.setDrawColor(0, 123, 255);
            doc.setLineWidth(0.5);
            doc.line(margin, currentY, pageWidth - margin, currentY);
            currentY += 8;
          }
          
          // Adicionar cabeçalho inicial
          addHeader();
          
          // Ordenar os dias por data e período
          const periodOrder = { 'Manhã': 1, 'Tarde': 2, 'Noite': 3, 'Dia todo': 4 };
          const sortedDays = scheduleDays.sort((a, b) => {
            const dateA = new Date(a.date);
            const dateB = new Date(b.date);
            
            if (dateA.getTime() !== dateB.getTime()) {
              return dateA - dateB;
            }
            
            return (periodOrder[a.period] || 5) - (periodOrder[b.period] || 5);
          });
          
          // Cores para diferentes períodos
          const periodColors = {
            'Manhã': [40, 167, 69],      // Verde
            'Tarde': [253, 126, 20],     // Laranja
            'Noite': [111, 66, 193],     // Roxo
            'Dia todo': [0, 123, 255]    // Azul
          };
          
          // Processar cada dia
          sortedDays.forEach((day, index) => {
            // Estimar espaço necessário para este dia
            const peopleCount = day.allocatedPeople.length;
            const rolesCount = [...new Set(day.allocatedPeople.map(p => p.role))].length;
            const estimatedSpace = 25 + (rolesCount * 8) + (peopleCount * 5);
            
            // Verificar se precisa quebrar coluna/página
            checkPageBreak(estimatedSpace);
            
            // Converter data para exibição
            const [year, month, dayNum] = day.date.split('-');
            const date = new Date(year, month - 1, dayNum);
            const dayName = date.toLocaleDateString('pt-BR', { weekday: 'long' });
            const formattedDate = `${dayNum}/${month}/${year}`;
            const period = day.period || 'Dia todo';
            
            const columnX = getColumnX();
            const periodColor = periodColors[period] || [0, 123, 255];
            
            // Retângulo colorido de fundo para o cabeçalho do dia
            doc.setFillColor(periodColor[0], periodColor[1], periodColor[2]);
            doc.rect(columnX, currentY - 1, columnWidth, 12, 'F');
            
            // Cabeçalho do dia (texto branco sobre fundo colorido)
            doc.setFontSize(12);
            doc.setTextColor(255, 255, 255);
            doc.text(`${dayName.charAt(0).toUpperCase() + dayName.slice(1)}`, columnX + 2, currentY + 6);
            
            doc.setFontSize(10);
            doc.text(`${formattedDate} - ${period}`, columnX + 2, currentY + 10);
            currentY += 15;
            
            // Pessoas alocadas
            if (day.allocatedPeople.length > 0) {
              // Organizar por função
              const peopleByRole = {};
              day.allocatedPeople.forEach(person => {
                if (!peopleByRole[person.role]) {
                  peopleByRole[person.role] = [];
                }
                peopleByRole[person.role].push(person.name);
              });
              
              // Ordenar funções alfabeticamente
              const sortedRoles = Object.keys(peopleByRole).sort();
              
              sortedRoles.forEach((role, roleIndex) => {
                // Verificar se precisa quebrar coluna/página
                checkPageBreak(15);
                
                // Cor alternada para as funções
                const roleColor = roleIndex % 2 === 0 ? [248, 249, 250] : [233, 236, 239];
                
                // Fundo colorido para a função
                doc.setFillColor(roleColor[0], roleColor[1], roleColor[2]);
                doc.rect(getColumnX(), currentY - 1, columnWidth, 6, 'F');
                
                // Nome da função
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(`• ${role}:`, getColumnX() + 2, currentY + 3);
                currentY += 7;
                
                // Pessoas da função (ordenadas alfabeticamente)
                const sortedPeople = peopleByRole[role].sort();
                sortedPeople.forEach(personName => {
                  checkPageBreak(5);
                  
                  doc.setFontSize(9);
                  doc.setTextColor(60, 60, 60);
                  doc.text(`  - ${personName}`, getColumnX() + 5, currentY + 3);
                  currentY += 5;
                });
                
                currentY += 2;
              });
            } else {
              // Nenhuma pessoa alocada
              doc.setFontSize(9);
              doc.setTextColor(120, 120, 120);
              doc.text('Nenhuma pessoa escalada', getColumnX() + 2, currentY + 3);
              currentY += 8;
            }
            
            // Espaço entre dias
            currentY += 8;
            
            // Linha separadora entre dias (exceto o último)
            if (index < sortedDays.length - 1) {
              doc.setDrawColor(200, 200, 200);
              doc.setLineWidth(0.2);
              doc.line(getColumnX(), currentY, getColumnX() + columnWidth, currentY);
              currentY += 6;
            }
          });
          
          // Rodapé com informações
          const totalPages = doc.internal.getNumberOfPages();
          for (let i = 1; i <= totalPages; i++) {
            doc.setPage(i);
            
            // Retângulo de fundo para o rodapé
            doc.setFillColor(248, 249, 250);
            doc.rect(0, pageHeight - 15, pageWidth, 15, 'F');
            
            // Linha superior do rodapé
            doc.setDrawColor(0, 123, 255);
            doc.setLineWidth(0.5);
            doc.line(0, pageHeight - 15, pageWidth, pageHeight - 15);
            
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text(`Página ${i} de ${totalPages}`, pageWidth - margin, pageHeight - 8, { align: 'right' });
            doc.text(`Total de dias: ${scheduleDays.length}`, margin, pageHeight - 8);
            doc.text(`Total de pessoas: ${people.length}`, margin, pageHeight - 4);
            
            // Estatísticas por período
            const periodStats = {};
            scheduleDays.forEach(day => {
              const period = day.period || 'Dia todo';
              periodStats[period] = (periodStats[period] || 0) + 1;
            });
            
            let statsText = 'Períodos: ';
            Object.keys(periodStats).forEach((period, index) => {
              if (index > 0) statsText += ', ';
              statsText += `${period}: ${periodStats[period]}`;
            });
            
            doc.text(statsText, pageWidth / 2, pageHeight - 4, { align: 'center' });
          }
          
          // Salvar o PDF
          const today = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');
          doc.save(`cronograma-${today}.pdf`);
          
        } catch (error) {
          console.error('Erro ao gerar PDF:', error);
          showAlert('Erro ao gerar PDF. Tente novamente.');
        } finally {
          // Restaurar botão
          document.getElementById("exportPdfBtn").innerHTML = originalText;
          document.getElementById("exportPdfBtn").disabled = false;
        }
      }

      // Funcionalidade do botão de limpar dados
      document.getElementById("clearAllBtn").onclick = () => {
        new bootstrap.Modal(
          document.getElementById("confirmClearModal")
        ).show();
      };

      document.getElementById("confirmClearBtn").onclick = () => {
        people = [];
        scheduleDays = [];
        roles = ["Transmissão", "Fotos"]; // Resetar para funções padrão
        roleColors = { Transmissão: "#28a745", Fotos: "#fd7e14" }; // Resetar cores
        save();
        renderAll();
        bootstrap.Modal.getInstance(
          document.getElementById("confirmClearModal")
        ).hide();
        showAlert("Todos os dados foram removidos com sucesso!");
      };

      window.onload = renderAll;
    </script>
  </body>
</html>
